<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>GPS Map + AR</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 35vh!important; max-height: 50vh; width: 100%; }
    #coords { text-align: center; padding: 10px; font-size: 16px; }
    #ar-container { display: none; height: 50vh; width: 100%; }
    #version { position: absolute; top: 5px; left: 5px; font-size: 12px; color: gray; }
    button { margin: 5px; padding: 0.5em 1em; }
  </style>
</head>
<body>
<div id="version">v06</div>
<div id="map"></div>
<div id="coords">Loading...</div>
<div id="ar-container"></div>
<div id="buttons">
    <button onclick="window.location.href='Inventory.html'">Inventory</button>
    <button onclick="window.location.href='Weapon.html'">Weapon</button>
    <button onclick="window.location.href='Guess.html'">Guess</button>
    <button onclick="setScene('church')">Scene: Church</button>
    <button onclick="setScene('car park')">Scene: Car Park</button>
    <button onclick="setScene('supermarket')">Scene: Supermarket</button>
</div>

<script>
  const coordsDiv = document.getElementById('coords');
  const mapDiv = document.getElementById('map');
  const arContainer = document.getElementById('ar-container');
  let isFirstUpdate = true;
  let arScene = null;
  let inScene = false;
  let showAR = false;

  function setScene(scene) {
    if (localStorage.getItem('location') !== scene) {
      localStorage.setItem('location', scene);
      alert('Scene set to: ' + scene);
    }
  }

  function addWeapon(weapon) {
    localStorage.setItem('weapon', weapon);
    let weapons = JSON.parse(localStorage.getItem('weapons')) || [];
    if (!weapons.includes(weapon)) {
      weapons.push(weapon);
      localStorage.setItem('weapons', JSON.stringify(weapons));
      alert('You found ' + weapon);
    }
  }

  let gameLocs = JSON.parse(localStorage.getItem('gameLocations'));
  const map = L.map('map').setView([gameLocs[0].lat, gameLocs[0].long], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);
  let userMarker = L.marker([0, 0]).addTo(map);

  gameLocs.forEach(loc => {
    L.circle([loc.lat, loc.long], {
      color: loc.color,
      fillColor: loc.color,
      fillOpacity: 0.5,
      radius: loc.radius
    }).addTo(map);
  });

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function showARScene(weaponId, modelUrl, position, scale) {
    arContainer.innerHTML = `
      <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
        <a-camera gps-camera rotation-reader></a-camera>
        <a-entity gltf-model="${modelUrl}"
                  gps-entity-place
                  position="${position}"
                  scale="${scale}"
                  rotation="0 0 0"
                  static-body>
        </a-entity>
      </a-scene>
    `;
  }

  function updatePosition(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    coordsDiv.textContent = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
    userMarker.setLatLng([lat, lon]);
    if (isFirstUpdate) {
      map.setView([lat, lon], 15);
      isFirstUpdate = false;
    }

    inScene = false;
    showAR = false;
    localStorage.setItem('weapon', null);

    for (const loc of gameLocs) {
      const dist = getDistance(lat, lon, loc.lat, loc.long);
      if (dist <= loc.radius) {
        if (loc.weapon) {
          showAR = true;
          inScene = true;
          addWeapon(loc.weapon);
          showARScene(loc.weaponId,
                      loc.modelUrl,
                      "0 -5 -5",
                      loc.scale || "1 1 1");
        } else {
          inScene = true;
          setScene(loc.scene);
          coordsDiv.textContent = loc.scene;
        }
        break;
      }
    }

    if (!inScene) localStorage.setItem('location', null);
    mapDiv.style.display = showAR ? 'none' : 'block';
    arContainer.style.display = showAR ? 'block' : 'none';
  }

  function handleError(err) {
    coordsDiv.textContent = `GPS error: ${err.message}`;
  }

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(updatePosition, handleError, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 5000
    });
  } else {
    coordsDiv.textContent = "Geolocation not supported.";
  }
</script>
</body>
</html>